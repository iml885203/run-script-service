#!/bin/bash

# Pre-commit hook for Go project
# This script runs formatting, linting, and tests before each commit

set -e

echo "ğŸ” Running pre-commit checks..."

# Check if we're in a Go project
if [ ! -f "go.mod" ]; then
    echo "âŒ go.mod not found. This doesn't appear to be a Go project."
    exit 1
fi

# 1. Format code
echo "ğŸ“ Formatting Go code..."
if ! gofmt -l . | grep -q .; then
    echo "âœ… Code is properly formatted"
else
    echo "âŒ Code is not formatted. Running go fmt..."
    go fmt ./...
    echo "âœ… Code formatted. Please add the changes and commit again."
    exit 1
fi

# 2. Fix imports (if goimports is available)
if command -v goimports >/dev/null 2>&1; then
    echo "ğŸ“¦ Checking imports..."
    if ! goimports -l . | grep -q .; then
        echo "âœ… Imports are correct"
    else
        echo "âŒ Import issues found. Running goimports..."
        goimports -w .
        echo "âœ… Imports fixed. Please add the changes and commit again."
        exit 1
    fi
else
    echo "âš ï¸  goimports not found, skipping import check"
fi

# 3. Run linter
echo "ğŸ”§ Running linter..."
if command -v golangci-lint >/dev/null 2>&1; then
    if golangci-lint run --timeout=5m; then
        echo "âœ… Linting passed"
    else
        echo "âŒ Linting failed. Please fix the issues before committing."
        exit 1
    fi
else
    echo "âš ï¸  golangci-lint not found, running go vet instead"
    if go vet ./...; then
        echo "âœ… go vet passed"
    else
        echo "âŒ go vet failed"
        exit 1
    fi
fi

# 4. Run tests
echo "ğŸ§ª Running tests..."
if go test ./... -timeout=30s; then
    echo "âœ… All tests passed"
else
    echo "âŒ Tests failed. Please fix failing tests before committing."
    exit 1
fi

# 5. Check for common issues
echo "ğŸ” Checking for common issues..."

# Check for debugging prints (optional)
if grep -r "fmt.Print\|log.Print" --include="*.go" --exclude-dir=vendor .; then
    echo "âš ï¸  Found debugging print statements. Consider removing them."
    # Don't exit, just warn
fi

# Check for TODO/FIXME comments (optional)
if grep -r "TODO\|FIXME" --include="*.go" --exclude-dir=vendor . | head -5; then
    echo "âš ï¸  Found TODO/FIXME comments. Consider addressing them."
    # Don't exit, just warn
fi

echo "ğŸ‰ All pre-commit checks passed!"
echo "ğŸ’¡ Tip: You can run 'make pre-commit' manually to check before committing"

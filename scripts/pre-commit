#!/bin/bash

# Pre-commit hook for Go project
# This script runs formatting, linting, and tests before each commit

set -e

echo "🔍 Running pre-commit checks..."

# Check if we're in a Go project
if [ ! -f "go.mod" ]; then
    echo "❌ go.mod not found. This doesn't appear to be a Go project."
    exit 1
fi

# 1. Format code
echo "📝 Formatting Go code..."
if ! gofmt -l . | grep -q .; then
    echo "✅ Code is properly formatted"
else
    echo "❌ Code is not formatted. Running go fmt..."
    go fmt ./...
    echo "✅ Code formatted. Please add the changes and commit again."
    exit 1
fi

# 2. Fix imports (if goimports is available)
if command -v goimports >/dev/null 2>&1; then
    echo "📦 Checking imports..."
    if ! goimports -l . | grep -q .; then
        echo "✅ Imports are correct"
    else
        echo "❌ Import issues found. Running goimports..."
        goimports -w .
        echo "✅ Imports fixed. Please add the changes and commit again."
        exit 1
    fi
else
    echo "⚠️  goimports not found, skipping import check"
fi

# 3. Run linter
echo "🔧 Running linter..."
if command -v golangci-lint >/dev/null 2>&1; then
    if golangci-lint run --timeout=5m; then
        echo "✅ Linting passed"
    else
        echo "❌ Linting failed. Please fix the issues before committing."
        exit 1
    fi
else
    echo "⚠️  golangci-lint not found, running go vet instead"
    if go vet ./...; then
        echo "✅ go vet passed"
    else
        echo "❌ go vet failed"
        exit 1
    fi
fi

# 4. Run tests
echo "🧪 Running tests..."
if go test ./... -timeout=30s; then
    echo "✅ All tests passed"
else
    echo "❌ Tests failed. Please fix failing tests before committing."
    exit 1
fi

# 5. Check for common issues
echo "🔍 Checking for common issues..."

# Check for debugging prints (optional)
if grep -r "fmt.Print\|log.Print" --include="*.go" --exclude-dir=vendor .; then
    echo "⚠️  Found debugging print statements. Consider removing them."
    # Don't exit, just warn
fi

# Check for TODO/FIXME comments (optional)
if grep -r "TODO\|FIXME" --include="*.go" --exclude-dir=vendor . | head -5; then
    echo "⚠️  Found TODO/FIXME comments. Consider addressing them."
    # Don't exit, just warn
fi

echo "🎉 All pre-commit checks passed!"
echo "💡 Tip: You can run 'make pre-commit' manually to check before committing"
